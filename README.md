### 1. Генерация приватного ключа

```
openssl genrsa -out rootCA.key 2048
```
- `-out rootCA.key` — имя выходного файла, в который сохраняется приватный ключ.
- `2048` — длина ключа в битах.
---

### 2. Генерация самоподписанного сертификата

```
openssl req -x509 -new -nodes -key rootCA.key -sha256 -days 1024 -out rootCA.pem
```

- `req` — команда для создания запроса на сертификат (CSR) или самоподписанного сертификата.
- `-x509` — создание самоподписанного сертификата вместо запроса - получаем сразу сертификат.
- `-new` — указывает, что создаётся новый сертификат.
- `-nodes` — при создании приватного ключа не шифровать его симметричным алгоритмом (DES/AES).
- `-key rootCA.key` — путь к приватному ключу, которым подписывается сертификат.
- `-sha256` — использовать алгоритм SHA-256 при подписи.
- `-days 1024` — срок действия сертификата в днях.
- `-out rootCA.pem` — имя выходного файла для сертификата.

**Результат:** создаётся самоподписанный сертификат `rootCA.pem`, действующий 1024 дня, подписанный ключом `rootCA.key`.

### 3. Создание запроса на сертификат

```
openssl req -new -nodes -keyout task-service.local.key -out task-service.local.csr -config task-service.local.conf
```

- `req` — команда для создания запроса на сертификат.
- `-new` — создаёт новый запрос.
- `-nodes` — не шифровать приватный ключ.
- `-keyout task-service.local.key` — имя выходного файла для приватного ключа, который будет создан вместе с CSR.
- `-out task-service.local.csr` — имя выходного файла для CSR (Certificate Signing Request).
- `-config task-service.local.conf` — путь к конфигурационному файлу, в котором указаны параметры запроса.

**Результат:** создаётся:
- приватный ключ `task-service.local.key`
- запрос на сертификат `task-service.local.csr`

### 4. Подпись сертификата с помощью собственного корневого центра сертификации (CA)

```
openssl x509 -req -in task-service.local.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out task-service.local.crt -days 365
```

- `x509` — команда для управления сертификатами X.509 (создание, просмотр, подпись).
- `-req` — указывает, что входные данные — это CSR.
- `-in task-service.local.csr` — путь к входному CSR-файлу.
- `-CA rootCA.pem` — корневой сертификат, которым будет подписан итоговый сертификат.
- `-CAkey rootCA.key` — приватный ключ, соответствующий корневому сертификату.
- `-CAcreateserial` — если отсутствует файл серийного номера, он будет создан - создаётся файл `rootCA.srl`.
- `-out task-service.local.crt` — имя выходного файла для подписанного сертификата.
- `-days 365` — срок действия сертификата в днях - 1 год.

**Результат:** создаётся подписанный сертификат `task-service.local.crt`, выданный на основе запроса `task-service.local.csr` и подписанный корневым CA.

## Ansible-роли

Плейбук **nginx-tls_playbook.yml** 

1. Генерирует TLS-сертификаты для `task-service.local` с помощью роли `tls`.

2. Устанавливает и настраивает NGINX для работы с HTTPS через роль `nginx`.

## Правка в compose

Для того, чтобы ограничить возможность подключение к сервисе в обход nginx поменяем настройку проброса портов в compose.yml

вместо
```
ports:
    - "3002:3002"
```
укажем 
```
ports:
    - "127.0.0.1:3002:3002"
```
В такой конфигурации порт будет слушаться только на локальном интерфейсе - у nginx будет доступ к нему, а по внешнему IP получить доступ не получится 
